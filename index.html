<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Earthquake Explorer – Interactive Yearly Statistics & Polygon Analysis</title>
  <meta name="description" content="Free browser-based tool for real-time earthquake analysis using USGS data. Draw custom polygons, filter by magnitude & date, view charts and export CSV."/>

  <!-- Leaflet + Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"/>

  <style>
    body {font-family: system-ui, sans-serif; margin:0; padding:0; background:#f9fbfc; color:#333;}
    .container {max-width:900px; margin:30px auto; padding:20px; background:#fff; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.08);}
    h1, h2, h3 {color:#1a5276;}
    #eq-poly-map {height:450px; margin:20px 0; border-radius:8px; border:2px solid #ddd;}
    .controls {background:#f5f5f5; padding:15px; border-radius:8px; margin:20px 0;}
    button {background:#007bff; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:600;}
    button:hover {background:#0056b3;}
    .stats {display:flex; flex-wrap:wrap; gap:15px; margin:20px 0;}
    .stat-box {flex:1; min-width:130px; text-align:center; background:#f0f8ff; padding:12px; border-radius:8px; border:1px solid #aed6f1;}
    .stat-box b {display:block; font-size:1.5em; color:#1a5276;}
    .footer {margin-top:40px; padding-top:20px; border-top:1px solid #eee; font-size:0.9em; color:#666; text-align:center;}
    @media(max-width:640px){.stats{flex-direction:column;}}
  </style>
</head>
<body>

<div class="container">
  <h1>Earthquake Explorer</h1>
  <p><strong>Interactive global earthquake statistics with custom polygon filtering – powered by USGS real-time data.</strong></p>

  <canvas id="eq-year-chart" height="120"></canvas>

  <div id="eq-poly-map"></div>

  <div class="controls">
    <form id="eqstat-form">
      <label>Start Date <input type="date" name="start" value="2000-01-01" required /></label>
      <label>End Date <input type="date" name="end" required /></label>
      <label>Min Mag <input type="number" step="0.1" name="minmag" value="5.0" style="width:80px;" /></label>
      <label>Max Mag <input type="number" step="0.1" name="maxmag" value="9.9" style="width:80px;" /></label>
      <button type="submit">Analyze Selected Area</button>
    </form>
  </div>

  <div id="eqstat-results"></div>

  <div style="text-align:right; margin:15px 0;">
    <button id="btn-download-csv">Download as CSV</button>
  </div>

  <table id="eqstat-table" class="display" style="width:100%"></table>

  <div class="footer">
    Data source: <a href="https://earthquake.usgs.gov" target="_blank">U.S. Geological Survey (USGS)</a> • 
    This tool is not affiliated with USGS • Last updated <span id="last-update"></span>
  </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
// Tüm JavaScript kodun (senin orijinal kodun biraz temizlenmiş hâli)
(() => {
  let map, markersLayer, drawnItems, activePolygon = null;
  let currentFeatures = [];
  let chartInstance = null;
  let dataTable = null;

  // Default end date = today
  document.querySelector('input[name="end"]').valueAsDate = new Date();
  document.getElementById('last-update').textContent = new Date().toLocaleString();

  // Chart
  const updateChart = (features, context) => {
    const years = {};
    features.forEach(f => {
      const y = new Date(f.properties.time).getUTCFullYear();
      years[y] = (years[y] || 0) + 1;
    });
    const labels = Object.keys(years).sort();
    const data = labels.map(y => years[y]);

    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(document.getElementById('eq-year-chart'), {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Events', data, backgroundColor: 'rgba(52, 152, 219, 0.7)' }] },
      options: { responsive: true, plugins: { title: { display: true, text: `Earthquakes per Year ${context}` } } }
    });
  };

  // Map init
  const initMap = () => {
    map = L.map('eq-poly-map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    markersLayer = L.featureGroup().addTo(map);
    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: { polygon: { allowIntersection: false }, marker: false, circle: false, rectangle: false, polyline: false, circlemarker: false },
      edit: { featureGroup: drawnItems }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, e => {
      drawnItems.clearLayers();
      activePolygon = e.layer;
      drawnItems.addLayer(activePolygon);
    });
    map.on(L.Draw.Event.DELETED, () => activePolygon = null);
  };

  // Point-in-polygon
  const pointInPoly = (lat, lng, poly) => {
    if (!poly) return true;
    const pts = poly.getLatLngs()[0];
    let inside = false;
    for (let i = 0, j = pts.length - 1; i < pts.length; j = i++) {
      const xi = pts[i].lat, yi = pts[i].lng;
      const xj = pts[j].lat, yj = pts[j].lng;
      const intersect = ((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  };

  // Stats
  const calcStats = features => {
    const bins = { '4-4.9':0, '5-5.9':0, '6-6.9':0, '7+':0 };
    let sum = 0;
    features.forEach(f => {
      const m = f.properties.mag || 0;
      sum += m;
      if (m >=7) bins['7+']++;
      else if (m >=6) bins['6-6.9']++;
      else if (m >=5) bins['5-5.9']++;
      else bins['4-4.9']++;
    });
    return { total: features.length, avg: features.length ? (sum/features.length).toFixed(2) : 0, bins };
  };

  const renderStats = s => {
    document.getElementById('eqstat-results').innerHTML = `
      <div class="stats">
        <div class="stat-box"><b>${s.total}</b>Total Events</div>
        <div class="stat-box"><b>${s.avg}</b>Avg Magnitude</div>
        <div class="stat-box"><b>${s.bins['5-5.9']}</b>M 5.0–5.9</div>
        <div class="stat-box"><b>${s.bins['6-6.9']}</b>M 6.0–6.9</div>
        <div class="stat-box" style="background:#ffebee;"><b>${s.bins['7+']}</b>M 7.0+</div>
      </div>`;
  };

  // Table + Markers
  const updateTableMap = features => {
    markersLayer.clearLayers();
    const rows = features.map(f => {
      const p = f.properties, c = f.geometry.coordinates;
      const color = p.mag >=7 ? '#c62828' : p.mag >=5 ? '#ef6c00' : '#2e7d32';
      L.circleMarker([c[1], c[0]], {radius: Math.max(p.mag*1.8, 5), color, fillOpacity:0.7})
       .bindPopup(`<b>${p.place}</b><br>Magnitude: ${p.mag}<br>${new Date(p.time).toLocaleDateString()}`)
       .addTo(markersLayer);
      return [p.mag, p.place, new Date(p.time).toLocaleDateString(), c[2]+' km', `<a href="${p.url}" target="_blank">Details</a>`];
    });

    if (features.length) map.fitBounds(markersLayer.getBounds());

    if (dataTable) dataTable.destroy();
    dataTable = $('#eqstat-table').DataTable({
      data: rows,
      columns: [{title:"Mag"},{title:"Location"},{title:"Date"},{title:"Depth"},{title:"Link"}],
      order: [[0,"desc"]],
      pageLength: 15
    });
  };

  // Form submit
  $('#eqstat-form').on('submit', function(e){
    e.preventDefault();
    const btn = $(this).find('button').prop('disabled',true).text('Loading…');
    const f = Object.fromEntries(new FormData(this));
    const params = new URLSearchParams({
      format:'geojson', starttime:f.start, endtime:f.end,
      minmagnitude:f.minmag, maxmagnitude:f.maxmag, limit:20000, orderby:'time'
    });
    fetch(`https://earthquake.usgs.gov/fdsnws/event/1/query?${params}`)
      .then(r=>r.json())
      .then(d => {
        let feats = d.features;
        if (activePolygon) {
          feats = feats.filter(f => pointInPoly(f.geometry.coordinates[1], f.geometry.coordinates[0], activePolygon));
        }
        currentFeatures = feats;
        const context = activePolygon ? '(Selected Area)' : '(Global)';
        updateChart(feats, context);
        renderStats(calcStats(feats));
        updateTableMap(feats);
      })
      .finally(()=> btn.prop('disabled',false).text('Analyze Selected Area'));
  });

  // CSV download
  $('#btn-download-csv').on('click', () => {
    if (!currentFeatures.length) return alert('Run an analysis first!');
    let csv = "Time,Magnitude,Place,Depth (km),Latitude,Longitude,URL\n";
    currentFeatures.forEach(f=>{
      const p=f.properties, c=f.geometry.coordinates;
      csv += `"${new Date(p.time).toISOString()}","${p.mag}","${(p.place||'').replace(/"/g,'""')}","${c[2]}","${c[1]}","${c[0]}","${p.url}"\n`;
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='earthquake_data.csv'; a.click();
  });

  // Initial load (global M6+ since 1990)
  fetch('https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&starttime=1990-01-01&minmagnitude=6&limit=15000')
    .then(r=>r.json())
    .then(d=> updateChart(d.features, '(Global M6+ 1990–today)'));

  initMap();
})();
</script>
</body>
</html>
